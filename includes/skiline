<h1 id='skiline-integration'>Skiline integration</h1>
<p>Data exchange between system provided by metadata params and widget callback.</p>

<p>Callback would send back all result related data on each survey state changes.</p>

<p>Webhook would send all data to endpoint, once survey is completed.</p>
<h2 id='connect-widget-callback'>Connect widget callback</h2>
<p>Instructions how to implement a callback mechanism in a JavaScript web application
that communicates with both <code>Android</code> and <code>iOS</code> platforms through WebView.</p>

<p>We have implemented a feature that allows our JavaScript web application to communicate with native <code>Android</code> and <code>iOS</code> components using WebView.
This feature enables seamless data exchange and interaction between the web app and the mobile platforms.</p>

<p>Here&#39;s a step-by-step guide to implementing this feature:</p>

<p><code>1. *** Android Integration ***:</code></p>

<ul>
<li><p>In <code>Android WebView</code>, enable JavaScript and set up a JavaScript interface that will serve as a bridge between the WebView and native Android code.</p></li>
<li><p>When developing a web application that&#39;s designed specifically for the WebView in your Android app, you can create interfaces between your JavaScript code and client-side Android code.
Our <code>Front-end part(JavaScript code)</code> can call a method in your Android code to send data to your app
For example, you can include the following class in your Android app:</p></li>
</ul>

<p><code>
    class WebAppInterface(private val mContext: Context) { <br/>
        /** reveice data from Screver app  **/ <br/>
        fun onDataReceived(data) { ... } <br/>
    }
</code></p>

<p>In this example, the <code>WebAppInterface</code> class allows the web page to send data, using the <code>onDataReceived()</code> method.</p>

<p>You can bind this class to the JavaScript that runs in your WebView with <code>addJavascriptInterface()</code> and name the interface <code>Android</code>. For example:</p>

<p><code>webView.addJavascriptInterface(WebAppInterface(this), &quot;Android&quot;)</code></p>

<p>On our side we&#39;ll use function:</p>

<p><code>Android.onDataReceived(dataToSend)</code></p>

<p><code>2. *** iOS Integration ***:</code></p>

<ul>
<li><p>In <code>iOS WebView</code>, configure the WebView to handle JavaScript messages using the <code>WKScriptMessageHandler</code> protocol.</p></li>
<li><p>Implement the <code>userContentController(_:didReceive:)</code> function in your iOS code to receive and process the JavaScript message.
Add a script message handler to receive messages from the web app: 
<code>
configuration.userContentController.add(self, name: &quot;callbackHandler&quot;)
</code></p></li>
</ul>

<p>On our side we&#39;ll use function: </p>

<p><code>window.webkit.messageHandlers.callbackHandler.postMessage(dataToSend)</code></p>

<p><strong>Response</strong></p>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
 </span><span class="s2">"completed"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="w">
 </span><span class="s2">"statusBarData"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="s2">"passed"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="w">
  </span><span class="s2">"passedSection"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="w">
  </span><span class="s2">"total"</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="w">
  </span><span class="s2">"totalSection"</span><span class="p">:</span><span class="mi">3</span><span class="w">
 </span><span class="p">},</span><span class="w">
 </span><span class="s2">"survey"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"64e752ca97a1131105c9c62a"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Survey name"</span><span class="w">
 </span><span class="p">},</span><span class="w">
 </span><span class="s2">"meta"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"User Name"</span><span class="w">
 </span><span class="p">},</span><span class="w">
 </span><span class="s2">"answer"</span><span class="p">:{</span><span class="w">
  </span><span class="s2">"64ac09a858298c30bb797e5a"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"value"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
  </span><span class="p">}</span><span class="w">
 </span><span class="p">},</span><span class="w">
 </span><span class="s2">"height"</span><span class="p">:</span><span class="s2">"205px"</span><span class="p">,</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<table><thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>completed</td>
<td>bool</td>
<td>Survey passed</td>
</tr>
<tr>
<td>height</td>
<td>string</td>
<td>height of Screver widget</td>
</tr>
<tr>
<td>answer</td>
<td>object</td>
<td>answers data</td>
</tr>
<tr>
<td>survey</td>
<td>object</td>
<td>id - survey id, name - survey name</td>
</tr>
<tr>
<td>statusBarData</td>
<td>object</td>
<td>survey progress data</td>
</tr>
<tr>
<td>meta</td>
<td>object</td>
<td>meta params</td>
</tr>
</tbody></table>
<h2 id='meta-data-object'>Meta data object</h2>
<p>Meta data - data could be passed on creation of result, data would be returned back on widget callback or webhook.</p>

<p>Could contain any useful information like userId, timestamp, eventType, etc. - can be used later to aggregate survey results.</p>

<p>Format: URL query object</p>

<p>Example query:</p>

<p><code>?meta.userId=123&amp;meta.timestamp=1692872269&amp;meta.eventType=first_visit</code></p>
<h2 id='meta-data-access-control'>Meta data access control</h2>
<p>It is possible to restrict access to survey by meta.</p>

<p>In survey settings &quot;Meta control&quot; tab, you could define meta access key, if activated, then only possible to answer survey, if present <code>meta.accessKey</code> </p>

<p>Example query:</p>

<p><code>?meta.accessKey=123123</code></p>

<p>Only results with correct <code>meta.accessKey</code> would init, rest - raise error.</p>
<h2 id='meta-variables-whitelist'>Meta variables whitelist</h2>
<p>You can define whitelist of meta-variables, to be used in survey answering form.
Only whitelisted variables would be processed.</p>

<p>Config - survey settings &quot;Meta control&quot; tab.
Each key would have value (fallback), in case if value would be not mapped from URL params</p>

<p>Example whitelist:</p>

<p><code>{ firstName: &#39;User&#39;, service: &#39;provider&#39; }</code></p>

<p>Example query:</p>

<p><code>?meta.firstName=John&amp;meta.service=Alturos</code></p>

<p>In result, you can define question like:</p>

<p><code>Hi ${firstName}, please rate our ${service}</code>,</p>

<p>variables data would be taken from URL meta params</p>
<h2 id='survey-query-params'>Survey query params</h2>
<p>Survey query params - query params that could modify answering flow for the end user.</p>
<h3 id='switch-language'>Switch language</h3>
<p>Query param - &quot;lang&quot;, could override default survey language for the end user, but only if survey have translation for provided language.</p>

<p>Value - locale shortcode.</p>

<p>Example: <code>?lang=de</code></p>
<h3 id='force-reload-result'>Force reload result</h3>
<p>If survey have enabled config &quot;allowReload&quot; activated, 
then it is possible to start new result from same device by pass URL param: &quot;reloadResult&quot;</p>

<p>Example: <code>?reloadResult=true</code></p>

<p>Then new result would be created for the same device, old result would be still keeped in system, but not possible to answer.
On success initialization - param would be removed from ULR by system.</p>
